const { Client, GatewayIntentBits, Partials, ActivityType } = require("discord.js");
const express = require("express");
const cors = require("cors"); // <-- BURAYA EKLENDİ
require("dotenv").config();

const app = express();
app.use(cors());  // <-- BURAYA EKLENDİ

const PORT = process.env.PORT || 3000;

let presenceData = {};

const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildPresences,
    GatewayIntentBits.GuildMembers
  ],
  partials: [Partials.User]
});

client.once("ready", () => {
  console.log(`Bot hazır: ${client.user.tag}`);
  trackUser(process.env.USER_ID);
});

async function trackUser(userId) {
  const guilds = client.guilds.cache;

  for (const [guildId, guild] of guilds) {
    try {
      const member = await guild.members.fetch(userId);
      updatePresence(member);
      break;
    } catch (err) {
      // Kullanıcı bu sunucuda yoksa diğer sunucuya geç
      continue;
    }
  }
}

client.on("presenceUpdate", (oldPresence, newPresence) => {
  if (newPresence.userId === process.env.USER_ID) {
    updatePresence(newPresence.member);
  }
});

function updatePresence(member) {
  const user = member.user;

  const activities = member.presence?.activities.map(act => {
    const startTimestamp = act.timestamps?.start || null;
    const endTimestamp = act.timestamps?.end || null;

    let elapsed = null;
    let totalDuration = null;

    if (startTimestamp) {
      const now = Date.now();
      elapsed = Math.floor((now - startTimestamp) / 1000);
      if (endTimestamp) {
        totalDuration = Math.floor((endTimestamp - startTimestamp) / 1000);
      }
    }

    return {
      name: act.name,
      type: ActivityType[act.type],
      details: act.details || null,
      state: act.state || null,
      elapsedSeconds: elapsed,
      totalSeconds: totalDuration,
      assets: act.assets || null,
    };
  }) || [];

  presenceData = {
    username: user.username,
    discriminator: user.discriminator,
    avatarURL: user.displayAvatarURL({ dynamic: true }),
    status: member.presence?.status || "offline",
    activities,
    flags: user.flags?.toArray() || []
  };

  console.log("Güncellendi:", presenceData);
}

app.get("/", (req, res) => {
  res.send("Bot çalışıyor.");
});

app.get("/api/discord-presence", (req, res) => {
  res.json(presenceData);
});

app.listen(PORT, () => {
  console.log(`Web sunucusu ${PORT} portunda dinliyor`);
});

client.login(process.env.DISCORD_TOKEN);

